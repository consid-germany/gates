"use strict";var se=Object.defineProperty;var je=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var Pe=Object.prototype.hasOwnProperty;var Re=(e,t)=>{for(var r in t)se(e,r,{get:t[r],enumerable:!0})},Ee=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Oe(t))!Pe.call(e,s)&&s!==r&&se(e,s,{get:()=>t[s],enumerable:!(n=je(t,s))||n.enumerable});return e};var Ue=e=>Ee(se({},"__esModule",{value:!0}),e);var ot={};Re(ot,{handler:()=>it});module.exports=Ue(ot);var h=class extends Error{},m=class extends h{constructor(t,r,n){super(t),this.failedAssertion={actual:r,expected:n}}},f=class extends h{constructor(t,r){let n=r!=null?`${t}: ${r}`:t;super(n)}},w=class extends h{},R=class extends h{},E=class extends m{},p=class extends m{withRawJwt({header:t,payload:r}){return this.rawJwt={header:t,payload:r},this}},K=class extends p{},q=class extends p{},H=class extends p{},z=class extends p{},V=class extends p{};var x=class extends h{},b=class extends h{},B=class extends h{},S=class extends h{},G=class extends h{},L=class extends h{},Z=class extends m{},Y=class extends m{},k=class extends h{constructor(t,r){super(`Failed to fetch ${t}: ${r}`)}},v=class extends k{};var $=require("crypto");var C;(function(e){e[e.Universal=0]="Universal"})(C||(C={}));var I;(function(e){e[e.Primitive=0]="Primitive",e[e.Constructed=1]="Constructed"})(I||(I={}));var A;(function(e){e[e.BitString=3]="BitString",e[e.ObjectIdentifier=6]="ObjectIdentifier",e[e.Sequence=16]="Sequence",e[e.Null=5]="Null",e[e.Integer=2]="Integer"})(A||(A={}));function U(e){let t=e.class<<7|e.primitiveOrConstructed<<5|e.tag;return Buffer.from([t])}function F(e){if(e<128)return Buffer.from([e]);let t=[];for(;e>0;)t.push(e%256),e=e>>8;return t.reverse(),Buffer.from([128|t.length,...t])}function he(e){return e[0]>>7&&(e=Buffer.concat([Buffer.from([0]),e])),Buffer.concat([U({class:C.Universal,primitiveOrConstructed:I.Primitive,tag:A.Integer}),F(e.length),e])}function Fe(e){let t=e.split(".").map(i=>parseInt(i)),r=t[0]*40+t[1],n=t.slice(2).reduce((i,o)=>{let u=[];do u.push(o%128),o=o>>7;while(o);return i.concat(u.map((a,c)=>c?a+128:a).reverse())},[]),s=Buffer.from([r,...n]);return Buffer.concat([U({class:C.Universal,primitiveOrConstructed:I.Primitive,tag:A.ObjectIdentifier}),F(s.length),s])}function De(e){let t=Buffer.concat([Buffer.from([0]),e]);return Buffer.concat([U({class:C.Universal,primitiveOrConstructed:I.Primitive,tag:A.BitString}),F(t.length),t])}function ie(e){let t=Buffer.concat(e);return Buffer.concat([U({class:C.Universal,primitiveOrConstructed:I.Constructed,tag:A.Sequence}),F(t.length),t])}function Ne(){return Buffer.concat([U({class:C.Universal,primitiveOrConstructed:I.Primitive,tag:A.Null}),F(0)])}var Me=ie([Fe("1.2.840.113549.1.1.1"),Ne()]);function oe(e,t){return ie([Me,De(ie([he(e),he(t)]))])}var ye=require("https");function we(e,t,r){if(t===429)throw new k(e,"Too many requests");if(t!==200)throw new v(e,`Status code is ${t}, expected 200`);if(!r||!r.toLowerCase().startsWith("application/json"))throw new v(e,`Content-type is "${r}", expected "application/json"`)}var ge=require("stream"),pe=require("util");function W(e){return typeof e=="object"&&!Array.isArray(e)&&e!==null}function D(e){return JSON.parse(e,(t,r)=>(typeof r=="object"&&!Array.isArray(r)&&r!==null&&(delete r.__proto__,delete r.constructor),r))}async function me(e,t,r){let n;return new Promise((s,i)=>{let o=(0,ye.request)(e,{method:"GET",...t},a=>{(0,ge.pipeline)([a,_e(e,a.statusCode,a.headers)],u)});t?.responseTimeout&&(n=setTimeout(()=>u(new k(e,`Response time-out (after ${t.responseTimeout} ms.)`)),t.responseTimeout),n.unref());function u(...a){if(n&&clearTimeout(n),a[0]==null){s(a[1]);return}o.socket?.emit("agentRemove");let c=a[0];c instanceof k||(c=new k(e,c.message)),o.destroy(),i(c)}o.on("error",u),o.end(r)})}function _e(e,t,r){return async n=>{we(e,t,r["content-type"]);let s=[];for await(let i of n)s.push(i);try{return D(new pe.TextDecoder("utf8",{fatal:!0,ignoreBOM:!0}).decode(Buffer.concat(s)))}catch(i){throw new v(e,i)}}}var Q;(function(e){e.RS256="RSA-SHA256",e.RS384="RSA-SHA384",e.RS512="RSA-SHA512"})(Q||(Q={}));var d={fetchJson:me,transformJwkToKeyObjectSync:e=>(0,$.createPublicKey)({key:oe(Buffer.from(e.n,"base64"),Buffer.from(e.e,"base64")),format:"der",type:"spki"}),transformJwkToKeyObjectAsync:async e=>(0,$.createPublicKey)({key:oe(Buffer.from(e.n,"base64"),Buffer.from(e.e,"base64")),format:"der",type:"spki"}),parseB64UrlString:e=>Buffer.from(e,"base64").toString("utf8"),verifySignatureSync:({alg:e,keyObject:t,jwsSigningInput:r,signature:n})=>(0,$.createVerify)(Q[e]).update(r).verify(t,n,"base64"),verifySignatureAsync:async({alg:e,keyObject:t,jwsSigningInput:r,signature:n})=>(0,$.createVerify)(Q[e]).update(r).verify(t,n,"base64"),defaultFetchTimeouts:{socketIdle:500,response:1500},setTimeoutUnref:(...e)=>setTimeout(...e).unref()};var X=d.fetchJson,ee=class{constructor(t){this.defaultRequestOptions={timeout:d.defaultFetchTimeouts.socketIdle,responseTimeout:d.defaultFetchTimeouts.response,...t?.defaultRequestOptions}}async fetch(t,r,n){r={...this.defaultRequestOptions,...r};try{return await X(t,r,n)}catch(s){if(s instanceof v)throw s;return X(t,r,n)}}};function j(e,t,r,n=m){if(!t)throw new n(`Missing ${e}. Expected: ${r}`,t,r);if(typeof t!="string")throw new n(`${e} is not of type string`,t,r);if(r!==t)throw new n(`${e} not allowed: ${t}. Expected: ${r}`,t,r)}function O(e,t,r,n=m){if(!t)throw new n(`Missing ${e}. ${ae(r)}`,t,r);if(typeof t!="string")throw new n(`${e} is not of type string`,t,r);return N(e,t,r,n)}function N(e,t,r,n=m){if(!t)throw new n(`Missing ${e}. ${ae(r)}`,t,r);let s=new Set(Array.isArray(r)?r:[r]);if(typeof t=="string"&&(t=[t]),!Array.isArray(t))throw new n(`${e} is not an array`,t,r);if(!t.some(o=>{if(typeof o!="string")throw new n(`${e} includes elements that are not of type string`,t,r);return s.has(o)}))throw new n(`${e} not allowed: ${t.join(", ")}. ${ae(r)}`,t,r)}function ae(e){return Array.isArray(e)?e.length>1?`Expected one of: ${e.join(", ")}`:`Expected: ${e[0]}`:`Expected: ${e}`}function Je(e,t){if(e&&typeof e.then=="function")throw t()}var qe=["use","alg","kid","n","e"],He=["kty"];function P(e,t){return e.keys.find(r=>r.kid!=null&&r.kid===t)}async function ze(e){let t=await X(e);return fe(t),t}async function be(e,t){if(!t.header.kid)throw new B("JWT header does not have valid kid claim");let r=await ze(e),n=P(r,t.header.kid);if(!n)throw new S(`JWK for kid "${t.header.kid}" not found in the JWKS`);return n}function fe(e){if(!e)throw new x("JWKS empty");if(!W(e))throw new x("JWKS should be an object");if(!Object.keys(e).includes("keys"))throw new x("JWKS does not include keys");if(!Array.isArray(e.keys))throw new x("JWKS keys should be an array");for(let t of e.keys)ve(t)}function ke(e){if(j("JWK use",e.use,"sig",Z),j("JWK kty",e.kty,"RSA",Y),!e.n)throw new b("Missing modulus (n)");if(!e.e)throw new b("Missing exponent (e)")}function ve(e){if(!e)throw new b("JWK empty");if(!W(e))throw new b("JWK should be an object");for(let t of He)if(typeof e[t]!="string")throw new b(`JWK ${t} should be a string`);for(let t of qe)if(t in e&&typeof e[t]!="string")throw new b(`JWK ${t} should be a string`)}function Se(e){try{return fe(e),!0}catch{return!1}}function xe(e){try{return ve(e),!0}catch{return!1}}var ce=class{constructor(t){this.waitingUris=new Map,this.waitSeconds=t?.waitSeconds??10}async wait(t){if(this.waitingUris.has(t))throw new G("Not allowed to fetch JWKS yet, still waiting for back off period to end")}release(t){let r=this.waitingUris.get(t);r&&(clearTimeout(r),this.waitingUris.delete(t))}registerFailedAttempt(t){let r=d.setTimeoutUnref(()=>{this.waitingUris.delete(t)},this.waitSeconds*1e3);this.waitingUris.set(t,r)}registerSuccessfulAttempt(t){this.release(t)}},te=class{constructor(t){this.jwksCache=new Map,this.fetchingJwks=new Map,this.penaltyBox=t?.penaltyBox??new ce,this.fetcher=t?.fetcher??new ee}addJwks(t,r){this.jwksCache.set(t,r)}async getJwks(t){let r=this.fetchingJwks.get(t);if(r)return r;let n=this.fetcher.fetch(t).then(i=>(fe(i),i));this.fetchingJwks.set(t,n);let s;try{s=await n}finally{this.fetchingJwks.delete(t)}return this.jwksCache.set(t,s),s}getCachedJwk(t,r){if(typeof r.header.kid!="string")throw new B("JWT header does not have valid kid claim");if(!this.jwksCache.has(t))throw new L(`JWKS for uri ${t} not yet available in cache`);let n=P(this.jwksCache.get(t),r.header.kid);if(!n)throw new S(`JWK for kid ${r.header.kid} not found in the JWKS`);return n}async getJwk(t,r){if(typeof r.header.kid!="string")throw new B("JWT header does not have valid kid claim");let n=this.jwksCache.get(t);if(n){let o=P(n,r.header.kid);if(o)return o}await this.penaltyBox.wait(t,r.header.kid);let s=await this.getJwks(t),i=P(s,r.header.kid);if(i)this.penaltyBox.registerSuccessfulAttempt(t,r.header.kid);else throw this.penaltyBox.registerFailedAttempt(t,r.header.kid),new S(`JWK for kid "${r.header.kid}" not found in the JWKS`);return i}};var Ce=["RS256","RS384","RS512"];function Ve(e){if(!W(e))throw new f("JWT header is not an object");if(e.alg!==void 0&&typeof e.alg!="string")throw new f("JWT header alg claim is not a string");if(e.kid!==void 0&&typeof e.kid!="string")throw new f("JWT header kid claim is not a string")}function Ge(e){if(!W(e))throw new f("JWT payload is not an object");if(e.exp!==void 0&&!Number.isFinite(e.exp))throw new f("JWT payload exp claim is not a number");if(e.iss!==void 0&&typeof e.iss!="string")throw new f("JWT payload iss claim is not a string");if(e.sub!==void 0&&typeof e.sub!="string")throw new f("JWT payload sub claim is not a string");if(e.aud!==void 0&&typeof e.aud!="string"&&(!Array.isArray(e.aud)||e.aud.some(t=>typeof t!="string")))throw new f("JWT payload aud claim is not a string or array of strings");if(e.nbf!==void 0&&!Number.isFinite(e.nbf))throw new f("JWT payload nbf claim is not a number");if(e.iat!==void 0&&!Number.isFinite(e.iat))throw new f("JWT payload iat claim is not a number");if(e.scope!==void 0&&typeof e.scope!="string")throw new f("JWT payload scope claim is not a string");if(e.jti!==void 0&&typeof e.jti!="string")throw new f("JWT payload jti claim is not a string")}function Ie(e){if(!e)throw new f("Empty JWT");if(typeof e!="string")throw new f("JWT is not a string");if(!e.match(/^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$/))throw new f("JWT string does not consist of exactly 3 parts (header, payload, signature)");let[t,r,n]=e.split("."),[s,i]=[t,r].map(d.parseB64UrlString),o;try{o=D(s)}catch(a){throw new f("Invalid JWT. Header is not a valid JSON object",a)}Ve(o);let u;try{u=D(i)}catch(a){throw new f("Invalid JWT. Payload is not a valid JSON object",a)}return Ge(u),{header:o,headerB64:t,payload:u,payloadB64:r,signatureB64:n}}function ue(e,t){if(e.exp!==void 0&&e.exp+(t.graceSeconds??0)<Date.now()/1e3)throw new z(`Token expired at ${new Date(e.exp*1e3).toISOString()}`,e.exp);if(e.nbf!==void 0&&e.nbf-(t.graceSeconds??0)>Date.now()/1e3)throw new V(`Token can't be used before ${new Date(e.nbf*1e3).toISOString()}`,e.nbf);if(t.issuer!==null){if(t.issuer===void 0)throw new w("issuer must be provided or set to null explicitly");O("Issuer",e.iss,t.issuer,K)}if(t.audience!==null){if(t.audience===void 0)throw new w("audience must be provided or set to null explicitly");N("Audience",e.aud,t.audience,q)}t.scope!=null&&N("Scope",e.scope?.split(" "),t.scope,H)}function Ae(e,t){ke(t),t.alg&&j("JWT signature algorithm",e.alg,t.alg,E),O("JWT signature algorithm",e.alg,Ce,E)}async function Le(e,t,r,n=be,s=d.transformJwkToKeyObjectAsync){let{header:i,headerB64:o,payload:u,payloadB64:a,signatureB64:c}=e,l=await n(t,e);Ae(e.header,l);let J=await s(l,i.alg,u.iss);if(!await d.verifySignatureAsync({jwsSigningInput:`${o}.${a}`,signature:c,alg:i.alg,keyObject:J}))throw new R("Invalid signature");try{ue(u,r),r.customJwtCheck&&await r.customJwtCheck({header:i,payload:u,jwk:l})}catch(g){throw r.includeRawJwtInErrors&&g instanceof p?g.withRawJwt(e):g}return u}function Ze(e,t,r,n){let{header:s,headerB64:i,payload:o,payloadB64:u,signatureB64:a}=e,c;if(xe(t))c=t;else if(Se(t)){let y=s.kid?P(t,s.kid):void 0;if(!y)throw new S(`JWK for kid ${s.kid} not found in the JWKS`);c=y}else throw new w([`Expected a valid JWK or JWKS (parsed as JavaScript object), but received: ${t}.`,"If you're passing a JWKS URI, use the async verify() method instead, it will download and parse the JWKS for you"].join());Ae(e.header,c);let l=n(c,s.alg,o.iss);if(!d.verifySignatureSync({jwsSigningInput:`${i}.${u}`,signature:a,alg:s.alg,keyObject:l}))throw new R("Invalid signature");try{if(ue(o,r),r.customJwtCheck){let y=r.customJwtCheck({header:s,payload:o,jwk:c});Je(y,()=>new w("Custom JWT checks must be synchronous but a promise was returned"))}}catch(y){throw r.includeRawJwtInErrors&&y instanceof p?y.withRawJwt(e):y}return o}var re=class{constructor(t,r=new te){if(this.jwksCache=r,this.issuersConfig=new Map,this.publicKeyCache=new de,Array.isArray(t)){if(!t.length)throw new w("Provide at least one issuer configuration");for(let n of t){if(this.issuersConfig.has(n.issuer))throw new w(`issuer ${n.issuer} supplied multiple times`);this.issuersConfig.set(n.issuer,this.withJwksUri(n))}}else this.issuersConfig.set(t.issuer,this.withJwksUri(t))}get expectedIssuers(){return Array.from(this.issuersConfig.keys())}getIssuerConfig(t){if(!t){if(this.issuersConfig.size!==1)throw new w("issuer must be provided");t=this.issuersConfig.keys().next().value}let r=this.issuersConfig.get(t);if(!r)throw new w(`issuer not configured: ${t}`);return r}cacheJwks(...[t,r]){let n=this.getIssuerConfig(r);this.jwksCache.addJwks(n.jwksUri,t),this.publicKeyCache.clearCache(n.issuer)}async hydrate(){let t=this.expectedIssuers.map(r=>this.getIssuerConfig(r).jwksUri).map(r=>this.jwksCache.getJwks(r));await Promise.all(t)}verifySync(...[t,r]){let{decomposedJwt:n,jwksUri:s,verifyProperties:i}=this.getVerifyParameters(t,r);return this.verifyDecomposedJwtSync(n,s,i)}verifyDecomposedJwtSync(t,r,n){let s=this.jwksCache.getCachedJwk(r,t);return Ze(t,s,n,this.publicKeyCache.transformJwkToKeyObjectSync.bind(this.publicKeyCache))}async verify(...[t,r]){let{decomposedJwt:n,jwksUri:s,verifyProperties:i}=this.getVerifyParameters(t,r);return this.verifyDecomposedJwt(n,s,i)}verifyDecomposedJwt(t,r,n){return Le(t,r,n,this.jwksCache.getJwk.bind(this.jwksCache),this.publicKeyCache.transformJwkToKeyObjectAsync.bind(this.publicKeyCache))}getVerifyParameters(t,r){let n=Ie(t);O("Issuer",n.payload.iss,this.expectedIssuers,K);let s=this.getIssuerConfig(n.payload.iss);return{decomposedJwt:n,jwksUri:s.jwksUri,verifyProperties:{...s,...r}}}withJwksUri(t){if(t.jwksUri)return t;let r=new URL(t.issuer).pathname.replace(/\/$/,"");return{jwksUri:new URL(`${r}/.well-known/jwks.json`,t.issuer).href,...t}}},M=class extends re{static create(t,r){return new this(t,r?.jwksCache)}},de=class{constructor(t=d.transformJwkToKeyObjectSync,r=d.transformJwkToKeyObjectAsync){this.transformJwkToKeyObjectSyncFn=t,this.transformJwkToKeyObjectAsyncFn=r,this.publicKeys=new Map}transformJwkToKeyObjectSync(t,r,n){let s=t.alg??r;if(!n||!t.kid||!s)return this.transformJwkToKeyObjectSyncFn(t,s,n);let i=this.publicKeys.get(n)?.get(t.kid)?.get(s);if(i)return i;let o=this.transformJwkToKeyObjectSyncFn(t,s,n);return this.putKeyObjectInCache(n,t.kid,s,o),o}async transformJwkToKeyObjectAsync(t,r,n){let s=t.alg??r;if(!n||!t.kid||!s)return this.transformJwkToKeyObjectAsyncFn(t,s,n);let i=this.publicKeys.get(n)?.get(t.kid)?.get(s);if(i)return i;let o=await this.transformJwkToKeyObjectAsyncFn(t,s,n);return this.putKeyObjectInCache(n,t.kid,s,o),o}putKeyObjectInCache(t,r,n,s){let i=this.publicKeys.get(t),o=i?.get(r);o?o.set(n,s):i?i.set(r,new Map([[n,s]])):this.publicKeys.set(t,new Map([[r,new Map([[n,s]])]]))}clearCache(t){this.publicKeys.delete(t)}};var Ye="ALLOWED_SUB_PATTERNS";function Te(){return{issuer:"https://token.actions.githubusercontent.com",jwksUri:"https://token.actions.githubusercontent.com/.well-known/jwks",audience:"consid-germany/gates",allowedSubPatterns:Qe()}}function Qe(){let e=JSON.parse(Xe(Ye));if(!et(e))throw new Error("could not parse allowedSubPatterns");return e}function Xe(e){let t=process.env[e];if(!t)throw new Error(`${e} environment variable is not set`);return t}function et(e){return Array.isArray(e)&&e.every(t=>typeof t=="string")}function le(e){return e==="-"||e==="^"||e==="$"||e==="+"||e==="."||e==="("||e===")"||e==="|"||e==="["||e==="]"||e==="{"||e==="}"||e==="*"||e==="?"||e==="\\"?"\\".concat(e):e}function tt(e){for(var t="",r=0;r<e.length;r++)t+=le(e[r]);return t}function Ke(e,t){if(t===void 0&&(t=!0),Array.isArray(e)){var r=e.map(function($e){return"^".concat(Ke($e,t),"$")});return"(?:".concat(r.join("|"),")")}var n="",s="",i=".";t===!0?(n="/",s="[/\\\\]",i="[^/\\\\]"):t&&(n=t,s=tt(n),s.length>1?(s="(?:".concat(s,")"),i="((?!".concat(s,").)")):i="[^".concat(s,"]"));for(var o=t?"".concat(s,"+?"):"",u=t?"".concat(s,"*?"):"",a=t?e.split(n):[e],c="",l=0;l<a.length;l++){var J=a[l],y=a[l+1],g="";if(!(!J&&l>0)){if(t&&(l===a.length-1?g=u:y!=="**"?g=o:g=""),t&&J==="**"){g&&(c+=l===0?"":g,c+="(?:".concat(i,"*?").concat(g,")*?"));continue}for(var T=0;T<J.length;T++){var _=J[T];_==="\\"?T<J.length-1&&(c+=le(J[T+1]),T++):_==="?"?c+=i:_==="*"?c+="".concat(i,"*?"):c+=le(_)}c+=g}}return c}function rt(e,t){if(typeof t!="string")throw new TypeError("Sample must be a string, but ".concat(typeof t," given"));return e.test(t)}function Be(e,t){if(typeof e!="string"&&!Array.isArray(e))throw new TypeError("The first argument must be a single pattern string or an array of patterns, but ".concat(typeof e," given"));if((typeof t=="string"||typeof t=="boolean")&&(t={separator:t}),arguments.length===2&&!(typeof t>"u"||typeof t=="object"&&t!==null&&!Array.isArray(t)))throw new TypeError("The second argument must be an options object or a string/boolean separator, but ".concat(typeof t," given"));if(t=t||{},t.separator==="\\")throw new Error("\\ is not a valid separator because it is used for escaping. Try setting the separator to `true` instead");var r=Ke(e,t.separator),n=new RegExp("^".concat(r,"$"),t.flags),s=rt.bind(null,n);return s.options=t,s.pattern=e,s.regexp=n,s}function We(e,t){if(e.sub===void 0)return!1;for(let r of t)if(Be(r,!1)(e.sub))return!0;return!1}var nt="Bearer ",ne=Te(),st=M.create({issuer:ne.issuer,audience:ne.audience,jwksUri:ne.jwksUri,customJwtCheck:async({payload:e})=>{if(!We(e,ne.allowedSubPatterns))throw new Error("sub not allowed")}}),it=async e=>{let t=e.headers?.authorization;if(!t)return{isAuthorized:!1};let r=t.replace(nt,"");try{await st.verify(r)}catch{return{isAuthorized:!1}}return{isAuthorized:!0}};0&&(module.exports={handler});
