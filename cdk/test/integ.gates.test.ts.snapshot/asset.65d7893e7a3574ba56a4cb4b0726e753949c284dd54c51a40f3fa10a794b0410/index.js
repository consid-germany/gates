"use strict";var I=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var m=Object.prototype.hasOwnProperty;var _=(e,t)=>{for(var r in t)I(e,r,{get:t[r],enumerable:!0})},D=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of T(t))!m.call(e,i)&&i!==r&&I(e,i,{get:()=>t[i],enumerable:!(o=l(t,i))||o.enumerable});return e};var N=e=>D(I({},"__esModule",{value:!0}),e);var F={};_(F,{handler:()=>p});module.exports=N(F);var n=require("@aws-sdk/client-secrets-manager"),a=require("@aws-sdk/client-cloudfront"),c="AWSPENDING",E="AWSCURRENT",g="Deployed",w=f("CLOUDFRONT_DISTRIBUTION_ID"),C=f("X_VERIFY_ORIGIN_HEADER_NAME"),V=f("ORIGIN_TEST_URL"),s=new n.SecretsManagerClient,R=new a.CloudFrontClient,p=async(e,t)=>{switch(e.Step){case"createSecret":await b(e.SecretId,e.ClientRequestToken);break;case"setSecret":await O(e.SecretId,e.ClientRequestToken);break;case"testSecret":await h(e.SecretId,e.ClientRequestToken);break;case"finishSecret":await U(e.SecretId,e.ClientRequestToken);break}};async function b(e,t){await s.send(new n.GetSecretValueCommand({SecretId:e}));try{await s.send(new n.GetSecretValueCommand({SecretId:e,VersionId:t,VersionStage:c}))}catch(r){if(r instanceof n.ResourceNotFoundException||r instanceof n.InvalidRequestException){let o=await s.send(new n.GetRandomPasswordCommand({ExcludePunctuation:!0}));await s.send(new n.PutSecretValueCommand({SecretId:e,ClientRequestToken:t,SecretString:o.RandomPassword,VersionStages:[c]}))}}}async function O(e,t){if((await R.send(new a.GetDistributionCommand({Id:w}))).Distribution?.Status!=g)throw new Error(`cloudfront distribution is not in state ${g}`);let o=await s.send(new n.GetSecretValueCommand({SecretId:e,VersionId:t,VersionStage:c})),i=await R.send(new a.GetDistributionConfigCommand({Id:w})),d=i.DistributionConfig;d?.Origins?.Items?.forEach(S=>{S.CustomHeaders?.Items?.filter(u=>u.HeaderName===C).forEach(u=>{u.HeaderValue=o.SecretString})}),await R.send(new a.UpdateDistributionCommand({Id:w,IfMatch:i.ETag,DistributionConfig:d}))}async function h(e,t){let r=await s.send(new n.GetSecretValueCommand({SecretId:e,VersionId:t,VersionStage:c}));if(r.SecretString===void 0)throw new Error("could not find pending secret value");if(!(await fetch(V,{headers:{[C]:r.SecretString}})).ok)throw new Error("failed to access origin test url")}async function U(e,t){let r=await s.send(new n.DescribeSecretCommand({SecretId:e}));if(r.VersionIdsToStages===void 0)throw new Error("could not find versions of secret");let o=Object.entries(r.VersionIdsToStages).find(([d,S])=>S.includes(E));if(o===void 0)throw new Error("could not find current version of secret");o[0]!=t&&await s.send(new n.UpdateSecretVersionStageCommand({SecretId:e,VersionStage:E,MoveToVersionId:t,RemoveFromVersionId:o[0]}))}function f(e){let t=process.env[e];if(!t)throw new Error(`${e} environment variable is not set`);return t}0&&(module.exports={handler});
